---
title: "Santo André"
output:
  html_notebook:
    code_fold: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup}
library(tidyverse)

# Libraries to IMPORT data
library(pins) # pins remote resources into a local cache to work offline
library(readxl) # Read Excel Files
library(read.dbc) # read datasus dbc files

# Libraries for Databases
library(DBI)
library(odbc)

# Libraries to TIDY data
library(janitor) # simple functions for examining and cleaning dirty data

# Libraries to TRANSFORM data

# Libraries to VISUALIZE data
library(fishualize) # Visualization of fish color palette


# Libraries to MODEL data
#library(broom) # summarizes key information about models in tidy tibble()s.
#library(corrr) # is a package for exploring correlations in R
#library(infer) # perform statistical inference

# Other useful libraries
#library(here) # helps accessing files relative to a project root to stop the working directory insanity
library(RVerbalExpressions) # Create regular expressions easily
library(beepr) # Easily Play Notification Sounds on any Platform
#library(feather) # legacy. fast, interoperable binary data frame storage for R and python
library(arrow) # substitutes *feather* package and introduces *parquet* file type (hadoop) - fast and small. the gold standard
library(fst) # fst file type. faster than *parquet* but larger file size. good for ssd (can read from disk as if in memmory, see fst())



library(sidrar)
library(datasus)
library(scales)
```

## 1.1. DESCRIÇÃO E ANALISE das principais características epidemiológicas e dos problemas de saúde mais prevalentes em Santo André.

### 1.1.1. Envelhecimento Populacional

**Pirâmide Etária, Santo André, 2000 e 2010**

```{r fig_piramide_etaria, cache=TRUE}
# Dowload dos dados do site do IBGE
# População por sexo e faixa etária para criação de uma pirâmide populacional
# Censos de 2000 e 2010
piramide <-
  sidrar::get_sidra(1552,
            period = c("2000", "2010"),
            variable = 93, # população residente
            classific = c("c2", "c287"), # sexo e idade
            category = list(
              c(92956, 92957), # homem e mulher
              c(93070, 93084:93100, 6653) # grupos etários de 5 em 5 anos
              ),
            geo = "City",
            geo.filter = 3547809, # Santo André - SP
            header = TRUE
  )

piramide2 <- piramide %>%
  select(Ano, Sexo, Idade, `População` = Valor) %>%
  mutate(`Faixa Etária` = factor(Idade, levels = unique(Idade), ordered = TRUE))

homens <- piramide2 %>%
  filter(Sexo == "Homem") %>%
  mutate(`População` = `População` * -1)

mulheres <- piramide2 %>%
  filter(Sexo == "Mulher")


# Função para formatação do gráfico
absolute_format <- function(accuracy = 1, scale = 1, prefix = "",
                          suffix = "", big.mark = ".", decimal.mark = ",",
                          trim = TRUE, ...) {
  function(x) number(
      abs(x),
      accuracy = accuracy,
      scale = scale,
      prefix = prefix,
      suffix = suffix,
      big.mark = big.mark,
      decimal.mark = decimal.mark,
      trim = trim,
      ...
    )
}

# Plota
ggplot(data = piramide2, aes(x = `Faixa Etária`, fill = Sexo)) +
  geom_col(data = homens, aes(y = `População`)) +
  geom_col(data = mulheres, aes(y = `População`)) +
  coord_flip()+
  facet_wrap(~Ano)+
  scale_y_continuous(labels = absolute_format())+
  scale_fill_manual(name = "",
                    values = c(Homem = "#3E606F", Mulher = "#8C3F4D"),
                    labels = c("Homens", "Mulheres"))


```

* População de Santo André atravessando um processo de envelhecimento populacional;
* No último censo (2010), a faixa etária com o maior número de pessoas foi a de 25 a 29 anos.






### 1.1.2. Causas de Morte

**Número e proporção acumulada de óbitos residentes, segundo Capítulo da CID-10, Santo André, 2008-2017**

```{r fig_obitos_causas, fig.height=7, fig.width=7}
obitos_por_causas <- sim_obt10_mun(
  municipio = 354780,
  linha = "Capítulo CID-10",
  periodo = c(as.character(2008:2017)))

obitos_por_causas %>% filter(`Capítulo CID-10` != "TOTAL") %>%
  arrange(desc(`Óbitos p/Residênc`)) %>%
  mutate(
    `Capítulo CID-10` = str_replace(`Capítulo CID-10`, "^[:upper:]+\\.[:blank:]*", ""),
    proporcao_acumulada = max(`Óbitos p/Residênc`)*cumsum(`Óbitos p/Residênc`) / sum(`Óbitos p/Residênc`)
    ) %>%
  ggplot(aes(x = reorder(`Capítulo CID-10`, -`Óbitos p/Residênc`))) +
    geom_col(aes(y = `Óbitos p/Residênc`, fill = `Capítulo CID-10`)) +
    geom_line(aes(y = proporcao_acumulada, group = 1)) +
    scale_y_continuous(sec.axis = sec_axis(trans = ~./16718*100, name = "% acum.", breaks = 1:10*10)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    xlab("Capítulo CID-10") + ylab("Óbitos") +
    scale_fill_fish_d(option = "Hypsypops_rubicundus", direction = -1, guide = FALSE)

```
* Cerca de 80% de todos os óbitos estão concentrados em 5 capítulos da CID-10;
* A principal causa de morte foram as Doenças do Aparelho Circulatório, responsáveis por cerca de 35% de todos os óbitos;
* A segunda principal causa de morte foram as Neoplasias, seguidas das Doenças do Aparelho Circulatório, das Causas Externas de Morbidade e Mortalidade e das Doenças do Aparelho Digestivo.




**Número de óbitos residentes, por faixa etária e Capítulo da CID-10, Santo André, 2008-2017**

```{r fig_obitos_idade_causas, fig.height=8, fig.width=14}

obitos_por_idade_e_causas <- sim_obt10_mun(
  municipio = 354780,
  linha = "Capítulo CID-10",
  coluna = "Faixa Etária",
  periodo = c(as.character(2008:2017)))

obitos_por_idade_e_causas2 <-
  obitos_por_idade_e_causas %>%
  pivot_longer(2:13, names_to = "Faixa Etária", values_to = "obitos") %>%
  select("Capítulo CID-10", `Faixa Etária`, "obitos") %>%
  filter(`Capítulo CID-10` != "TOTAL",!(is.na(obitos))) %>%
  mutate(
    `Capítulo CID-10` = str_replace(`Capítulo CID-10`, "^[:upper:]+\\.[:blank:]*", ""),
    `Faixa Etária` = factor(
      `Faixa Etária`,
      levels = unique(`Faixa Etária`),
      ordered = TRUE
      )
    )

obitos_por_idade_e_causas2 %>%
  ggplot() +
  geom_col(aes(
    x = `Faixa Etária`,
    y = obitos,
    fill = reorder(`Capítulo CID-10`, obitos)
  )) +
  scale_fill_fish_d(option = "Hypsypops_rubicundus", direction = -1, name = "Capítulo da CID-10")
```





### 1.1.3. Doenças do Aparelho Circulatório

**Número de óbitos por Doenças do Aparelho Circulatório, segundo sexo e faixa etária, Santo André, 2008-2017**

```{r fig_piramide_obitos_cardio}

piramide_obitos_cardio <- sim_obt10_mun(
  municipio = 354780,
  linha = "Faixa Etária",
  coluna = "Sexo",
  periodo = c(as.character(2008:2017)),
  capitulo_cid10 = 9
)

piramide_obitos_cardio2 <- piramide_obitos_cardio %>%
  pivot_longer(cols = c("Masc", "Fem"),
               names_to = "Sexo",
               values_to = "Óbitos") %>%
  filter(!(`Faixa Etária` %in% c("TOTAL", "Idade ignorada"))) %>%
  mutate(faixa_etaria = factor(`Faixa Etária`,
                               levels = unique(`Faixa Etária`),
                               ordered = TRUE))%>%
  select(`Faixa Etária` = faixa_etaria, Sexo, `Óbitos`)



# Plota
absolute_format <- function(accuracy = 1, scale = 1, prefix = "",
                          suffix = "", big.mark = ".", decimal.mark = ",",
                          trim = TRUE, ...) {
  function(x) number(
      abs(x),
      accuracy = accuracy,
      scale = scale,
      prefix = prefix,
      suffix = suffix,
      big.mark = big.mark,
      decimal.mark = decimal.mark,
      trim = trim,
      ...
    )
}

ggplot(data = piramide_obitos_cardio2, aes(x = `Faixa Etária`, y = `Óbitos`, fill = Sexo)) +
  geom_col(data = piramide_obitos_cardio2[piramide_obitos_cardio2$Sexo=="Masc",], aes(y = -`Óbitos`)) +
  geom_col(data = piramide_obitos_cardio2[piramide_obitos_cardio2$Sexo=="Fem",]) +
  coord_flip() +
  scale_y_continuous(labels = absolute_format())
```

* Os óbito por Doenças do Aparelho Circulatório estão concentradas nas faixas estárias mais velhas.





### 1.1.3. Neoplasias

**Número de óbitos por Neoplasias, segundo sexo e faixa etária, Santo André, 2008-2017**
```{r fig_piramide_obitos_cancer}
piramide_obitos_cancer <- sim_obt10_mun(
  municipio = 354780,
  linha = "Faixa Etária",
  coluna = "Sexo",
  periodo = c(as.character(2008:2017)),
  capitulo_cid10 = 2
)

piramide_obitos_cancer2 <-
  piramide_obitos_cancer %>%
  pivot_longer(cols = c("Masc", "Fem"),
               names_to = "Sexo",
               values_to = "Óbitos") %>%
  filter(!(`Faixa Etária` %in% c("TOTAL", "Idade ignorada"))) %>%
  mutate(faixa_etaria = factor(`Faixa Etária`,
                               levels = unique(`Faixa Etária`),
                               ordered = TRUE))%>%
  select(`Faixa Etária` = faixa_etaria, Sexo, `Óbitos`)



# Plota
absolute_format <- function(accuracy = 1, scale = 1, prefix = "",
                          suffix = "", big.mark = ".", decimal.mark = ",",
                          trim = TRUE, ...) {
  function(x) number(
      abs(x),
      accuracy = accuracy,
      scale = scale,
      prefix = prefix,
      suffix = suffix,
      big.mark = big.mark,
      decimal.mark = decimal.mark,
      trim = trim,
      ...
    )
}

ggplot(data = piramide_obitos_cancer2, aes(x = `Faixa Etária`, y = `Óbitos`, fill = Sexo)) +
  geom_col(data = piramide_obitos_cancer2[piramide_obitos_cancer2$Sexo=="Masc",], aes(y = -`Óbitos`)) +
  geom_col(data = piramide_obitos_cancer2[piramide_obitos_cancer2$Sexo=="Fem",]) +
  coord_flip() +
  scale_y_continuous(labels = absolute_format())
```

* Óbitos por Neoplasias concentrados nas faixas etárias mais velhas;






**Número de óbitos masculinos residentes por Neoplasias, segundo faixa etária e Categoria da CID-10, Santo André, 2008-2017**
```{r fig_obitos_masc_idade_tipo_cancer, fig.height=10, fig.width=15}

obitos_por_idade_e_causas <- sim_obt10_mun(
  municipio = 354780,
  linha = "Categoria CID-10",
  coluna = "Faixa Etária",
  periodo = c(as.character(2008:2017)),
  capitulo_cid10 = 2,
  sexo = "Masc"
)

temp <- 
obitos_por_idade_e_causas %>%
  pivot_longer(2:13, names_to = "Faixa Etária", values_to = "Óbitos") %>%
  select("Categoria CID-10", "Faixa Etária", "Óbitos") %>%
  filter(`Categoria CID-10` != "TOTAL") %>%
  mutate(
    `Faixa Etária` = factor(
      `Faixa Etária`,
      levels = unique(`Faixa Etária`),
      ordered = TRUE
      )
  ) %>%
  filter(!(is.na(`Óbitos`)))

temp2 <- 
  temp %>%
  group_by(`Categoria CID-10`) %>%
  summarise(sum(`Óbitos`))

temp3 <- 
  left_join(temp, temp2) %>% mutate(
    `Categoria CID-10` = fct_lump(
      `Categoria CID-10`,
      n = 5,
      w = `sum(Óbitos)`,
      other_level = "Outros"
      ),
    `Categoria CID-10` = fct_reorder(
      `Categoria CID-10`,`Óbitos`, sum,.desc = TRUE
      )
  )

temp3 %>%
  ggplot() +
    geom_col(
      aes(x = `Faixa Etária`, y = `Óbitos`, fill = `Categoria CID-10`),
      position = position_stack(reverse = TRUE)
      ) +
    scale_fill_fish_d(option = "Hypsypops_rubicundus", direction = 1)
```

* Câncer que mais matou: de Pulmão;
* Seguido do de próstata (aumento a partir da faixa etária dos 60 a 69 anos);









